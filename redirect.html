<script>
(function () {
  const ANDROID_PACKAGE = 'com.zoho.backstage';
  const IOS_APP_ID = '1324912655';
  const ANDROID_WEB_URL = `https://play.google.com/store/apps/details?id=${ANDROID_PACKAGE}`;
  const IOS_WEB_URL = `https://apps.apple.com/in/app/zoho-backstage-for-attendees/id${IOS_APP_ID}`;
  const HASH_TRIGGER = '#/qrcode';
  // Detect if opened from the mobile app; guard require for non-module envs
  let IS_FROM_APP = false;
  try {
    const mod = (typeof require === 'function') ? require('commons/services/mobile-service') : null;
    const candidate = mod && (mod.default ? mod.default.prototype?.isFromApp : mod.prototype?.isFromApp);
    IS_FROM_APP = typeof candidate === 'function' ? !!candidate() : !!candidate;
  } catch (_e) {
    IS_FROM_APP = false;
  }

  function detectPlatform() {
    const ua = navigator.userAgent || '';
    const isAndroid = /android/i.test(ua);
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    return { isAndroid, isIOS };
  }

  function openWithFastFallback(deepLink, webLink) {
    let fallbackId = null;
    let didHide = false;

    const onVisibility = () => {
      if (document.hidden) {
        didHide = true;
        if (fallbackId) clearTimeout(fallbackId);
      }
    };
    document.addEventListener('visibilitychange', onVisibility, { once: true });

    fallbackId = setTimeout(() => {
      if (!didHide) window.location.replace(webLink);
    }, 900);

    try {
      window.location.replace(deepLink);
    } catch (_) {
      if (fallbackId) clearTimeout(fallbackId);
      window.location.replace(webLink);
    }
  }

  function redirectToAppStores(options) {
    const {
      androidPackage,
      iosAppId,
      androidWebUrl,
      iosWebUrl
    } = options || {};

    if (!androidPackage || !iosAppId) return;

    const androidDeep = `market://details?id=${androidPackage}`;
    const iosDeep = `itms-apps://itunes.apple.com/app/id${iosAppId}`;
    const androidWeb = androidWebUrl || `https://play.google.com/store/apps/details?id=${androidPackage}`;
    const iosWeb = iosWebUrl || `https://apps.apple.com/app/id${iosAppId}`;

    const { isAndroid, isIOS } = detectPlatform();
    if (isAndroid) return openWithFastFallback(androidDeep, androidWeb);
    if (isIOS) return openWithFastFallback(iosDeep, iosWeb);
  }

  function shouldTrigger() {
    const hash = window.location.hash || '';
    const hashPath = hash.split('?')[0];
    return hashPath === HASH_TRIGGER;
  }

  let hasRedirected = false;
  function maybeRedirect() {
    if (hasRedirected) return;
    if (!shouldTrigger()) return;
    // If opened from app, route to home (remove /qrcode) and do not open stores
    if (IS_FROM_APP) {
      hasRedirected = true;
      // Replace #/qrcode (and any query) with # to land on home without adding history
      const newUrl = window.location.href.replace(/#\/qrcode(?:\?.*)?$/, '#');
      if (newUrl !== window.location.href) {
        try { history.replaceState(null, '', newUrl); } catch (_err) { window.location.replace(newUrl); }
      }
      return;
    }
    // External context: proceed with store redirection
    hasRedirected = true;
    redirectToAppStores({
      androidPackage: ANDROID_PACKAGE,
      iosAppId: IOS_APP_ID,
      androidWebUrl: ANDROID_WEB_URL,
      iosWebUrl: IOS_WEB_URL
    });
  }

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', maybeRedirect);
  } else {
    maybeRedirect();
  }
  window.addEventListener('hashchange', maybeRedirect);

  window.redirectToAppStores = window.redirectToAppStores || redirectToAppStores;
})();
</script>


