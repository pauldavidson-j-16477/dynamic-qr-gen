<script>
(function () {
  const ANDROID_PACKAGE = 'com.zoho.backstage';
  const IOS_APP_ID = '1324912655';
  const ANDROID_WEB_URL = `https://play.google.com/store/apps/details?id=${ANDROID_PACKAGE}`;
  const IOS_WEB_URL = `https://apps.apple.com/in/app/zoho-backstage-for-attendees/id${IOS_APP_ID}`;
  const HASH_TRIGGER = '#/qrcode';
  // Optional: direct app links (custom scheme / universal link / Android intent)
  // Set these if the app supports opening directly (preferred when installed)
  // Examples:
  //  - Android intent: 'intent://home#Intent;scheme=backstage;package=com.zoho.backstage;end'
  //  - Android custom scheme: 'backstage://home'
  //  - iOS custom scheme: 'backstage://home'
  //  - Universal link: 'https://your.app.link/path'
  // Provide app links via options when calling redirectToAppStores

  function detectPlatform() {
    const ua = navigator.userAgent || '';
    const isAndroid = /android/i.test(ua);
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    return { isAndroid, isIOS };
  }

  function openWithFastFallback(deepLink, webLink, fallbackDelayMs = 1500) {
    let fallbackId = null;
    let didHideOrUnload = false;

    const cancelFallback = () => {
      didHideOrUnload = true;
      if (fallbackId) clearTimeout(fallbackId);
    };

    const onVisibility = () => {
      if (document.hidden || document.visibilityState === 'hidden') cancelFallback();
    };
    const onPageHide = () => cancelFallback();
    const onBlur = () => cancelFallback();

    document.addEventListener('visibilitychange', onVisibility, { once: true });
    window.addEventListener('pagehide', onPageHide, { once: true });
    window.addEventListener('blur', onBlur, { once: true });

    fallbackId = setTimeout(() => {
      if (!didHideOrUnload) window.location.replace(webLink);
    }, fallbackDelayMs);

    try {
      window.location.replace(deepLink);
    } catch (_) {
      cancelFallback();
      window.location.replace(webLink);
    }
  }

  // Build Android intent URL with in-URL fallback to avoid timer flicker
  function buildAndroidIntentUrl(appLink, packageName, fallbackWebUrl) {
    try {
      // If already an intent with fallback, return as-is
      if (/^intent:\/\//i.test(appLink)) {
        if (/S\.browser_fallback_url=/.test(appLink)) return appLink;
        // Append fallback before ;end
        return appLink.replace(/;end$/i, `;S.browser_fallback_url=${encodeURIComponent(fallbackWebUrl)};end`);
      }

      const u = new URL(appLink);
      const scheme = (u.protocol || '').replace(':', '') || 'https';
      const hostAndPath = `${u.host || ''}${u.pathname || ''}${u.search || ''}${u.hash || ''}`;
      return `intent://${hostAndPath}#Intent;scheme=${scheme};package=${packageName};S.browser_fallback_url=${encodeURIComponent(fallbackWebUrl)};end`;
    } catch (_e) {
      // If parsing fails, fall back to market URL handling by caller
      return '';
    }
  }

  function redirectToAppStores(options) {
    const {
      androidPackage,
      iosAppId,
      androidWebUrl,
      iosWebUrl,
      androidAppLink,
      iosAppLink,
      preferAppLinkFirst = true
    } = options || {};

    if (!androidPackage || !iosAppId) return;

    const androidDeep = `market://details?id=${androidPackage}`;
    const iosDeep = `itms-apps://itunes.apple.com/app/id${iosAppId}`;
    const androidWeb = androidWebUrl || `https://play.google.com/store/apps/details?id=${androidPackage}`;
    const iosWeb = iosWebUrl || `https://apps.apple.com/app/id${iosAppId}`;

    const { isAndroid, isIOS } = detectPlatform();
    if (isAndroid) {
      const appLink = (preferAppLinkFirst && androidAppLink) || '';
      if (appLink) {
        const intentUrl = buildAndroidIntentUrl(appLink, androidPackage, androidWeb);
        if (intentUrl) return openWithFastFallback(intentUrl, androidWeb, 1400);
        return openWithFastFallback(appLink, androidWeb, 1600);
      }
      return openWithFastFallback(androidDeep, androidWeb, 1100);
    }
    if (isIOS) {
      const appLink = (preferAppLinkFirst && iosAppLink) || '';
      if (appLink) return openWithFastFallback(appLink, iosWeb, 1500);
      return openWithFastFallback(iosDeep, iosWeb, 1100);
    }
  }

  function shouldTrigger() {
    const hash = window.location.hash || '';
    const hashPath = hash.split('?')[0];
    return hashPath === HASH_TRIGGER;
  }

  let hasRedirected = false;
  function maybeRedirect() {
    if (hasRedirected) return;
    if (!shouldTrigger()) return;
    hasRedirected = true;
    redirectToAppStores({
      androidPackage: ANDROID_PACKAGE,
      iosAppId: IOS_APP_ID,
      androidWebUrl: ANDROID_WEB_URL,
      iosWebUrl: IOS_WEB_URL,
      preferAppLinkFirst: true
    });
  }

  if (document.readyState === 'loading') {
    window.addEventListener('DOMContentLoaded', maybeRedirect);
  } else {
    maybeRedirect();
  }
  window.addEventListener('hashchange', maybeRedirect);

  window.redirectToAppStores = window.redirectToAppStores || redirectToAppStores;
})();
</script>


